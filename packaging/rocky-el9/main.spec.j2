Name: {{ name }}
Version: {{ version }}
Release: {{ build_number }}%{?dist}
Summary: {{ description }}
License: {{ license }}
URL: {{ git_url }}
Source0: %{name}-%{version}.tar.gz
BuildArch: {{ architecture.rocky }}
Requires: {{ dependencies.rocky_common | join(',') }}

BuildRoot: %{_tmppath}/%{name}-%{version}-%{release}-root

%description
{{ title }}
{{ description }}

%prep
%setup -q

%build
make OS_PACKAGE_RELEASE=el9

%install
make DESTDIR=%{buildroot} install

%files
/usr/share/cockpit/scheduler/*
/opt/45drives/houston/scheduler/*

# D-Bus scheduler daemon + policy
%attr(0755, root, root) /usr/local/libexec/45drives-schedulerd
%config(noreplace) /usr/share/polkit-1/actions/com.45drives.scheduler.policy
%config(noreplace) /usr/share/polkit-1/rules.d/60-45drives-scheduler.rules

# Systemd unit (you currently stage it under /etc)
# (Do NOT mark as %config to avoid unmanaged divergence)
#/usr/lib/systemd/system/org.45drives.Scheduler.service   <-- preferred path
/etc/systemd/system/org.45drives.Scheduler.service

# State dirs owned by the package (created if missing)
%dir /var/lib/houston
%dir /var/lib/houston/scheduler
%dir /var/lib/houston/user-units
%dir /var/lib/houston/rclone

%post
# Ensure state dirs exist (idempotent)
mkdir -p /var/lib/houston/scheduler /var/lib/houston/user-units /var/lib/houston/rclone || true

# Reload systemd so the new unit is recognized
/bin/systemctl daemon-reexec || true
/bin/systemctl daemon-reload || true

# Enable and start the D-Bus service
if /bin/systemctl cat org.45drives.Scheduler.service &>/dev/null; then
    /bin/systemctl enable --now org.45drives.Scheduler.service || true
fi

%preun
if [ $1 -eq 0 ]; then
    # package removal (not upgrade)
    if /bin/systemctl is-enabled org.45drives.Scheduler.service &>/dev/null; then
        /bin/systemctl disable --now org.45drives.Scheduler.service || true
    fi
fi

%postun
/bin/systemctl daemon-reload || true


%changelog
* Mon Aug 04 2025 Jordan Keough <jkeough@45drives.com> 1.3.6-1
- Fixes syntax issue in autosnap-script.py so it works on Python 3.8+
* Tue Apr 15 2025 Jordan Keough <jkeough@45drives.com> 1.3.5-3
- Fixes bug with notes not editing properly for Cloud task
* Tue Apr 15 2025 Jordan Keough <jkeough@45drives.com> 1.3.5-2
- Updated ToolTip for CloudSync Target Path. Rebuilding package with build v2 process